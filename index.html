<html>
  <head>
    <meta charset="utf-8">
    <title>Example</title>
      <script src="components/platform/platform.js"></script>
      <link rel="import" href="components/polymer/polymer.html">
      <link rel="import" href="components/ace/ace-element.html">
      <link rel="import" href="components/code-mirror/code-mirror.html">
      <link rel="import" href="components/usco-viewer-base/three-viewer.html">
      <link rel="import" href="components/polymer-ui-tabs/polymer-ui-tabs.html">
     
     
      <script src="components/esprima/esprima.js"></script>
      <script src="components/estraverse/estraverse.js"></script>
      <script src="components/escope/escope.js"></script>
      <script src="components/esrefactor/lib/esrefactor.js"></script>

    <style>
      polymer-ui-tabs > * {
height: 30px;
line-height: 30px;
      }

polymer-ui-tabs > .polymer-selected {
background-color: rgb(85, 153, 255);
color: white;
background-position: initial initial;
background-repeat: initial initial;
border: 1px solid black;
border-radius: 4px 4px 0px 0px;
}

    </style>
  </head>
<body>
  
<!--
  <polymer-ui-tabs selected="0">
    <span>myProject.coffee*</span>
    <span>SuperPart.coffee</span>
  </polymer-ui-tabs>

mode="coffee"
-->

<script>
//AST experiment input
function test() {
var x = true;

  x = 23;	
  
  x+=1;
var toto = 245;
  
  toto += 23;
  
  if(toto >5)
  {
   console.log("kj"); 
  }
}
        
</script>

<script>
/*would be hidden*/

/*
function Part()
{
  THREE.Mesh.call(this, undefined, new THREE.MeshNormalMaterial());

  this._reflexed = null;
}
Part.prototype = Object.create( THREE.Mesh.prototype );
Part.prototype.constructor = Part;

function Cube(w,h,d)
{
  this.w = w || 50;
  this.h = h || 50;
  this.d = d || 50;

  Part.call( this );
  this.geometry = new THREE.CubeGeometry( this.w, this.d, this.h );
}
Cube.prototype = Object.create( Part.prototype );
Cube.prototype.constructor = Cube;


function Sphere(r)
{
  this.r = r || 25;

  Part.call( this );
  this.geometry = new THREE.SphereGeometry( this.r, 30, 30 );
}
Sphere.prototype = Object.create( Part.prototype );
Sphere.prototype.constructor = Sphere;



//here is the actual test
function CustomPart()
{
  Part.call( this );
  
  var subCube = new Cube(17,2.4,3);
  this.add(subCube);

  var subCube2 = new Cube(3,14,3);
  subCube.position.y = 27;

  this.add(subCube2);
}
CustomPart.prototype = Object.create( Part.prototype );
CustomPart.prototype.constructor = CustomPart;


function OtherPart()
{
  //updating this SHOULD NOT require recompiling the customPart class above
  Part.call( this );
  
  var subSphere = new Sphere(17,2);
  this.add(subSphere);
}
OtherPart.prototype = Object.create( Part.prototype );
OtherPart.prototype.constructor = OtherPart;


//instanciate
var youpi = new CustomPart();
assembly.add(youpi);

var youpla = new OtherPart();
assembly.add(youpla);


//OTHER

//var farb = new Cube(2);
//assembly.add(farb);

//basics
cube = new THREE.Mesh( new THREE.CubeGeometry( 50, 50, 50 ), new THREE.MeshNormalMaterial() );
cube.position.x = 10;

assembly.add(cube);


*/

/*user code*/
</script>

  <polymer-element name="cube-editor" attributes="target w h d position rotation" >
    <template>
      w: {{w}}
      h: {{h}}
      d: {{d}}
    </template>
    <script>
      Polymer("cube-editor",{});
    </script>
  </polymer-element>


  <polymer-element name="foo-editor">
    <template>
      <button on-click="{{compile}}"> Compile </button>
      <button on-click="{{analyze}}"> Analyze </button>
      <div>
        <code-mirror id="editor" theme="monokai" mode="javascript" boundValue="{{source}}" selection="{{selectedText}}"
cursor="{{cursorLocation}}" 
on-editor-input="{{editorChanged}}" style="position: absolute;width:50%;top:40px;height:100%">function test() {
var x = true;}
        </code-mirror>

        <!--<ace-element theme="solarized_dark" style="width:50%;top:40px" boundValue="{{source}}"  on-editor-input="{{editorChanged}}">


//basic
cube = new THREE.Mesh( new THREE.CubeGeometry( 50, 50, 50 ), new THREE.MeshNormalMaterial() );

cube.position.x = 10;

assembly.add(cube);

        </ace-element>-->
         <three-viewer id="viewer" style="position:absolute;left:50%;height:100%;width:50%" > </three-viewer>

          <cube-editor style="position: absolute;right:30px;z-index:999999"> </cube-editor>

        <div style="position:absolute; left:30%; top:0px"> Selected text: {{selectedText}}, cursor at: {{cursorLocation}}</div>

      </div>
    </template>
    <script>
    Polymer("foo-editor",{
      source:null,
      selectedText:null,
      cursorLocation : null,
      /*project:{files:
        {"toto.js":"some code here"}
      },*/

    created:function()
    {
      this.assembly = new THREE.Object3D();
      this.exports = {};
      this.include = function(){};
      this.importGeom = function(){};
      this.name = "totoModule";
    },
    enteredView:function()
    {
      this.$.viewer.addToScene(this.assembly);

      this.async(function(){ this.$.editor.refresh(); },200);
    },
    _wrapCode:function(code)
    {
       //var pre = "var assembly =  THREE.Object3D();\n"
       var pre = "return (function ( exports, include, importGeom, module, __filename, assembly)";
        pre +="{";
        pre += code;
        pre += "});";

       var result = pre;
       console.log("result", result);
       return result
    },
    compile:function()
    {
      //clear root assembly
      var child, i;
      for ( i = this.assembly.children.length - 1; i >= 0 ; i -- ) {
          child = this.assembly.children[ i ];
          this.assembly.remove(child);
      }
      var endSource = this._wrapCode(this.source);
      console.log("compiling");
      
      var startTime = new Date();
      try
      {
        var f = new Function(endSource);
        var fn = f();
        var result = fn.call(fn, this.exports, this.include, this.importGeom, this, this.name , this.assembly)
        console.log("result", result,this.assembly);
      }
      catch(error)
      {
        console.log("failed to compile:", error.name + ': ' + error.message);
      }
      var endTime = new Date();
      var elapsed = endTime - startTime;
      console.log("code compiling took:"+ elapsed)
    },
    analyze:function()
    {
      var startTime = new Date();
      try
      {
        console.log("bla",this.source)
        var ast = esprima.parse(this.source,{loc:true, range:true, tolerant:true});
        console.log("ast",ast, this.source)
        this.ast = ast;
      }
      catch(error)
      {
          console.log("failed to generate ast:", error.name + ': ' + error.message);
      }
      var endTime = new Date();
      var elapsed = endTime - startTime;
      console.log("AST generation took:"+ elapsed)
    },
    showRecompiledCode:function()
    {
      //TODO: find a way to display exactly WHAT section of the code was changed
    },
    sourceChanged:function()
    {
       this.compile();
       this.analyze();
    },
    cursorLocationChanged:function()
    {
      var context = new esrefactor.Context();
      if(!(this.source)) return;
      context.setCode(this.ast);
      if(context)
      {
        var id = context.identify(this.cursorLocation);
        console.log("selection info (from ast)",id)
        this.$.editor.clearMarkers();
        if( !(id && id.declaration)) { return;}

        console.log("declaration", id.declaration); 
        var pos = this.$.editor.mirror.posFromIndex(id.declaration.range[0]);
        console.log("pos",pos)
        this.$.editor.addMarker(pos.line);

      }
    },
    
    editorChanged:function(event, detail, sender)
    {
      //console.log("sender",sender )
      //console.log("editorValue",sender.value )
      //console.log("editorValue2",sender.editorValue )//.templateInstance.model.impl.editorValue);
      //this.source = sender.editorValue;
      //console.log("this.source", this.source);
    }
    });
    </script>
  </polymer-element>
  

  
<foo-editor> </foo-editor>

  

  <script>
    window.addEventListener('WebComponentsReady', function() {

      console.log("web components ready");
      document.body.style.opacity = 1; // show body now that registration is done.
	    //var aceEditor = document.querySelector('ace-element');
      //workaround for node-webkit 0.6.3      
      //aceEditor.style.opacity = 1;

    });
  </script>  
</body>
</html>
