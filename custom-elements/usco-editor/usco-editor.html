<link rel="import" href="../../components/polymer/polymer.html">

<link rel="import" href="../visual-editor/visual-editor.html">

<link rel="import" href="../../components/usco-client-deps/usco-client-deps.html">

<link rel="import" href="../../components/usco-asset-manager/usco-asset-manager.html">

<link rel="import" href="../../components/usco-xhr-store/xhr-store.html">
<link rel="import" href="../../components/usco-desktop-store/desktop-store.html">
<!--<link rel="import" href="../../components/usco-dropbox-store/dropbox-store.html">
<link rel="import" href="../../components/usco-fs-store/fs-store.html">-->

<link rel="import" href="../../components/usco-amf-serializer/amf-serializer.html">
<link rel="import" href="../../components/usco-stl-serializer/stl-serializer.html">
<link rel="import" href="../../components/usco-obj-serializer/obj-serializer.html">

<link rel="import" href="../../components/usco-amf-parser/amf-parser.html">
<link rel="import" href="../../components/usco-stl-parser/stl-parser.html">
<link rel="import" href="../../components/usco-obj-parser/obj-parser.html">
<link rel="import" href="../../components/usco-ply-parser/ply-parser.html">
<link rel="import" href="../../components/usco-ctm-parser/ctm-parser.html">


<polymer-element name="usco-editor">
<template>
  <style>
    visual-editor{
      width:100%;
      height:100%;
    }
    
    #codeGen{
      position: absolute;
      right: 10px;
      top: 20px;
      z-index: 3;
    }

    shape-creator{
      opacity : 0;
      z-index : 4;
    }
    history-editor{
       z-index:3;
      display:block;
      position:absolute;
      color:black;
      padding:5px;
      height:100%;
      width:200px
    }
    #commandsHistory{
      height:90%;
      overflow:auto;
    }

  </style>
  <usco-client-deps> </usco-client-deps>
  
  <visual-editor id="visualEditor"> </visual-editor>
  <!--<code-editor> </code-editor>-->
  <!--<code-mirror id="selectEdit" theme="monokai" mode="javascript" value="{{source}}" boundValue="{{altSource}}" >
    </code-mirror>-->
  
  <history-editor id="historyEditor"> </history-editor>
    <!--<drag-drop id="dragDropLayer"> </drag-drop>-->
    
  <!--various helpers: TODO:refactor-->
  <div id="codeGen" class="codeGen" style="position:absolute; right:10px;top:30px;z-index:3">
    <div>
      <button on-click="{{generateCodeFromHistory}}"> Generate code from history </button> </br>
      <button on-click="{{generateFromCode}}"> Generate shapes from code </button>
    </div>
  </div>
  
  <div id="modeSwitch" style="position:absolute; right:10px;top:100px;z-index:3">
    <select>
      <option> Design </option>
      <option> Build Plate </option>
      <option> Assembly Guide </option>
    </select>
  </div>
  
  <usco-asset-manager id="assetManager">
    <xhr-store> </xhr-store>
    <desktop-store> </desktop-store>
    <dropbox-store> </dropbox-store>
    <fs-store> </fs-store>

    <amf-serializer> </amf-serializer>
    <stl-serializer> </stl-serializer>
    <obj-serializer> </obj-serializer>

    <amf-parser> </amf-parser>
    <stl-parser> </stl-parser>
    <obj-parser> </obj-parser>
    <ply-parser> </ply-parser>
    <ctm-parser> </ctm-parser>
  </usco-asset-manager>
  
</template>
<script>
Polymer("usco-editor",{
  enteredView:function()
  {
    this.visualEditor   = this.$.visualEditor;
    this.commandManager = this.$.historyEditor;
    this.assetManager   = this.$.assetManager;
    //document.querySelector('usco-asset-manager');
    
    //if we recieve a "newOperation" event, add it to history  
    var self = this;
    this.addEventListener('newOperation', function(e) {
      console.log(e.type, e.detail.msg); 
      self.commandManager.addCommand( e.detail.msg );
    });
    this.addEventListener('text-dropped', function(e) {
      console.log(e.type, e.detail.data); 
      this.loadResource( e.detail.data );
    });
    this.addEventListener('files-dropped', function(e) {
      console.log(e.type, e.detail.data); 
      var files = e.detail.data;
      for (var i = 0, f; f = files[i]; i++) {
        this.loadResource( f );
      }
    });
    
    this.addEventListener('export-requested', function(e) {
      console.log(e.type, e.detail.data); 
      var stlSerializer = self.assetManager.assetManager.serializers["stl"];//STLSerializer//self.querySelector('stl-serializer');
      console.log("stlSerializer",stlSerializer);
      console.log("assetManager",self.assetManager.assetManager.serializers);
      
      var resultSTL = stlSerializer.serialize(e.detail.data.parent);
      console.log("resultStl", resultSTL);
      
      var ext = "stl";
      var link = document.createElement("a");

      var blob = new Blob([resultSTL],{type : 'application/'+ext})
      var url =  window.webkitURL.createObjectURL(blob);
        //var blobURL = window.webkitURL.createObjectURL(blob);
      
      link.href = url;
      link.download = "test.stl";
		  link.click();
      
    });
  },
  
  loadResource:function(uriOrData)
  {
    var self = this;
    var resourceDeferred = this.assetManager.loadResource(uriOrData);
    resourceDeferred.promise.then(function(resource){
      console.log("got resource data", resource);
      
      //geometry
      var geometry = resource.data;
      /*geometry.computeBoundingBox();
		  geometry.computeCentroids();
		  geometry.computeBoundingSphere();

      //needed at least for .ply files
      geometry.computeVertexNormals();
      geometry.computeFaceNormals();*/

      //nice color: 0x00a9ff
     //var material = new THREE.MeshPhongMaterial( { color: 0x17a9f5, specular: 0xffffff, shininess: 10, shading: THREE.FlatShading} );
      //var shape = new THREE.Mesh(geometry, material);
    
      //console.log("shape", shape);
      self.visualEditor.addImportedResource( resource ); 
    });
  
  },
  
  //generation of code based on history
  generateCodeFromHistory:function()
  {
     console.log("generating code from history");
     this.source = updateSelectionCode(this.selectedObject,this.commandManager.undos);
     console.log("res source", this.source);
  },
  generateFromCode:function()
  {
    console.log("generating from code",this.altSource);
    
    var result = eval(this.altSource)
    console.log("result", result);
  },

});
</script>
</polymer-element>
