<link rel="import" href="../../components/polymer/polymer.html">

<link rel="import" href="../../components/polymer-signals/polymer-signals.html">


<link rel="import" href="../visual-editor/visual-editor.html">
<link rel="import" href="../code-editor/code-editor.html">


<link rel="import" href="../../components/usco-command-manager/usco-command-manager.html">

<link rel="import" href="../../components/usco-client-deps/usco-client-deps.html">
<link rel="import" href="../../components/usco-asset-manager/usco-asset-manager.html">

<link rel="import" href="../../components/usco-xhr-store/xhr-store.html">
<link rel="import" href="../../components/usco-desktop-store/desktop-store.html">
<link rel="import" href="../../components/usco-dropbox-store/dropbox-store.html">
<link rel="import" href="../../components/usco-fs-store/fs-store.html">

<link rel="import" href="../../components/usco-amf-serializer/amf-serializer.html">
<link rel="import" href="../../components/usco-stl-serializer/stl-serializer.html">
<link rel="import" href="../../components/usco-obj-serializer/obj-serializer.html">

<link rel="import" href="../../components/usco-amf-parser/amf-parser.html">
<link rel="import" href="../../components/usco-stl-parser/stl-parser.html">
<link rel="import" href="../../components/usco-obj-parser/obj-parser.html">
<link rel="import" href="../../components/usco-ply-parser/ply-parser.html">
<link rel="import" href="../../components/usco-ctm-parser/ctm-parser.html">

<!--code generators and related -->
<script src="../visual-editor/lib/code-generation/code-generators.js"></script>
<script src="../visual-editor/lib/code-generation/code-generation-ui.js"></script>


<polymer-element name="usco-editor">
<template>
  <style>
    :host{
      position: absolute;
      top: 0px;
      left: 0px;
      overflow:hidden;
      /*font-family: Neue Helvetica, Roboto, Arial;*/

    }
    visual-editor{
      width:100%;
      height:100%;

    }
    visual-editor three-js
    {
       background-color:#ffffff;
    }
    
    #codeGen{
      position: absolute;
      right: 10px;
      top: 20px;
      z-index: 3;
    }

    shape-creator{
      opacity : 0;
      z-index : 4;
    }
    history-editor{
       z-index:3;
      display:block;
      position:absolute;
      color:black;
      padding:5px;
      height:100%;
      width:200px
    }
    #commandsHistory{
      height:90%;
      overflow:auto;
    }
  </style>
  <usco-client-deps> </usco-client-deps>
  <usco-asset-manager id="assetManager">
    <xhr-store> </xhr-store>
    <desktop-store> </desktop-store>
    <dropbox-store> </dropbox-store>
    <fs-store> </fs-store>

    <amf-serializer> </amf-serializer>
    <stl-serializer> </stl-serializer>
    <obj-serializer> </obj-serializer>

    <amf-parser> </amf-parser>
    <stl-parser> </stl-parser>
    <obj-parser> </obj-parser>
    <ply-parser> </ply-parser>
    <ctm-parser> </ctm-parser>
  </usco-asset-manager>
  
  <visual-editor id="visualEditor"> </visual-editor>
  
  <div id="codeEditorStuff" style="position:absolute; right:10px;top:300px;z-index:3">
    Code Editor <input type="checkbox"  checked="{{codeEditActive}}"> </input>
    <!--<button on-click="{{saveFileTest}}"> </button>
    <input type="file" nwdirectory />
    <input type="file" />
    <input type="file" nwsaveas />-->
    <button on-click="{{loginToDB}}">Login </button>
  </div>
  
  <div id="saveLoad" style="position:absolute; right:10px;top:5px;z-index:3">
    <div> 
      <button on-click="{{reqSave}}"> Save Design</button>
    </div>
    <button on-click="{{reqLoad}}"> Load Design</button>
    <button on-click="{{reqScreenshot}}">Screenshot</button>
  </div>
  
  <template if="{{codeEditActive}}">
    <code-editor id="codeEditor" theme="monokai" mode="javascript"  value="{{source}}"> </code-editor>
  </template>
  
  <history-editor id="historyEditor"> </history-editor>
    
  <!--various helpers: TODO:refactor-->
  <div id="codeGen" class="codeGen" style="position:absolute; right:10px;top:50px;z-index:3">
    <div>
      <button on-click="{{generateCodeFromHistory}}"> Generate code from history </button> </br>
      <button on-click="{{generateFromCode}}"> Generate shapes from code </button>
    </div>
  </div>
  
  <div id="modeSwitch" style="position:absolute; right:10px;top:100px;z-index:3">
    <select>
      <option> Design </option>
      <option> Build Plate </option>
      <option> Assembly Guide </option>
    </select>
  </div>
</div>
  
</template>
<script>
Polymer("usco-editor",{

  project:null,
  source:"",
  generateCodeOnTheFly:true,
  
  observe:{
    'project.files["foo"]':'codeChanged'
  },
  codeChanged:function()
  {
    console.log("code changed", this.project.files["foo"]);
  },
  sourceChanged:function()
  {
    console.log("source changed", this.source);
  },
  loginToDB:function()
  {
    var dropbBoxStore = this.assetManager.querySelector("dropbox-store");
    dropbBoxStore.login();
  },
  created:function()
  {
    this.project = {name:"testProject",files:{"foo":"bar"}};
    console.log("created", this.$);
  },
  ready:function()
  {
    console.log("ready", this.$);
  },
  enteredView:function()
  {
    console.log("entering view", this.$);
    this.visualEditor   = this.$.visualEditor;
    //this.codeEditor   = this.$.codeEditor;
    this.commandManager = this.$.historyEditor;
    this.assetManager   = this.$.assetManager;
    //document.querySelector('usco-asset-manager');
    
    //if we recieve a "newOperation" event, add it to history  
    var self = this;
    document.addEventListener('newOperation', function(e) {
          console.log(e);
      console.log(e.type, e.detail.msg); 
      self.commandManager.addCommand( e.detail.msg );
      
      if(self.generateCodeOnTheFly) self.generateCodeFromHistory();
    });
    
    //handle requests( keyboard events fire these in the visual editor)
    this.addEventListener('undoOperation', function(e) {
      self.commandManager.undo();
    });
    this.addEventListener('redoOperation', function(e) {
      self.commandManager.redo();
    });
    
    //handle history/commands/operations manager events
    this.addEventListener('commands-undone', function(e) {
      //console.log("something is undone!!!", e);
      if(self.generateCodeOnTheFly) self.generateCodeFromHistory();
    })
    
    this.addEventListener('commands-redone', function(e) {
      //console.log("something is redone!!!", e);
      if(self.generateCodeOnTheFly) self.generateCodeFromHistory();
    })
    
    this.addEventListener('text-dropped', function(e) {
      console.log(e.type, e.detail.data); 
      this.loadResource( e.detail.data );
    });
    this.addEventListener('files-dropped', function(e) {
      console.log(e.type, e.detail.data); 
      var files = e.detail.data;
      for (var i = 0, f; f = files[i]; i++) {
        this.loadResource( f );
      }
    });
    
    this.addEventListener('export-requested', function(e) {
      console.log(e.type, e.detail.data);
      var fileName = e.detail.fileName || "test";
      var format = e.detail.format;
      var data = e.detail.data;
      var fullName = ( fileName.indexOf(".") == -1)? fileName+"."+format : fileName;
      var serializer = self.assetManager.assetManager.serializers[format];//STLSerializer//self.querySelector('stl-serializer');
      
      if(serializer)
      {
        var result = serializer.serialize(data);
        var link = document.createElement("a");
        var blob = new Blob([result],{type : 'application/'+format})
        var url =  window.webkitURL.createObjectURL(blob);
          //var blobURL = window.webkitURL.createObjectURL(blob);
        link.href = url;
        link.download = fullName;
        link.click();
      }
      
    });
  },
  
  loadResource:function(uriOrData)
  {
    var self = this;
    var resourceDeferred = this.assetManager.loadResource(uriOrData);
    resourceDeferred.promise.then(function(resource){
      //geometry
      var geometry = resource.data;
      /*geometry.computeBoundingBox();
      geometry.computeCentroids();
      geometry.computeBoundingSphere();

      //needed at least for .ply files
      geometry.computeVertexNormals();
      geometry.computeFaceNormals();*/

      //nice color: 0x00a9ff
     //var material = new THREE.MeshPhongMaterial( { color: 0x17a9f5, specular: 0xffffff, shininess: 10, shading: THREE.FlatShading} );
      //var shape = new THREE.Mesh(geometry, material);
    
      //console.log("shape", shape);
      self.visualEditor.addImportedResource( resource ); 
    }).fail(function(error){
      console.log("failed to load resource", error);
    })
  
  },
  
  //generation of code based on history
  generateCodeFromHistory:function()
  {
     console.log("generating code from history");
     //generation scope priority order
     var generationScope = this.visualEditor.selectedObject || this.visualEditor.activeRoot || this.visualEditor.hierarchyRoot;
     var testSource = updateSelectionCode(generationScope,this.commandManager.undos);
     //this.source = updateSelectionCode(this.selectedObject,this.commandManager.undos);
     this.source = testSource;
  },
  generateFromCode:function()
  {
    console.log("generating from code",this.altSource);
    
    var result = eval(this.altSource)
    console.log("result", result);
  },
  reqScreenshot:function()
  {
    console.log("requesting screenshot");
    this.asyncFire('polymer-signal', {name: "request-screenshot", data:null});
  },
  saveFileTest:function()
  {
    function chooseFile(name) {
      var chooser = document.querySelector(name);
      chooser.addEventListener("change", function(evt) {
        console.log(this.value);
      }, false);

      chooser.click();  
    }
    chooseFile('#fileDialog');
  },
  reqSave:function()
  {
    console.log("requesting save design");
    this.asyncFire('polymer-signal', {name: "request-save-design", data:null});
    /*var exporter = new THREE.ObjectExporter()
    var exported = exporter.parse(this.assembly)
    exported = JSON.stringify(exported);*/
  },
  reqLoad:function()
  {
    console.log("requesting load design");
    this.asyncFire('polymer-signal', {name: "request-load-design", data:null});
    /*var reloadedAssembly = JSON.parse(reloadedAssembly.content);
    var loader = new THREE.ObjectParser()
    
    var assembly = loader.parse(reloadedAssembly)
    //@scene.add @assembly*/
  }

});
</script>
</polymer-element>
