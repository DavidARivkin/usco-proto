<html>
  <head>
    <title>Assembly guide viewer example</title>
      <script src="../../components/platform/platform.js"></script>
      <link rel="import" href="../tween-js/tween-js.html">
      <link rel="import" href="../../components/polymer-three-js/three-js.html">
      <link rel="import" href="../visual-helpers/visual-helpers.html">
      <link rel="import" href="../usco-base-ui/usco-iconsets.html">
      

<link rel="import" href="../../components/core-icon-button/core-icon-button.html">
<link rel="import" href="../../components/core-menu-button/core-menu-button.html">
<link rel="import" href="../../components/core-tooltip/core-tooltip.html">
<link rel="import" href="../../components/core-item/core-item.html">

<link rel="import" href="../../components/core-transition/core-transition.html">

      <style>
         html, body, three-js, assembly-viewer{
      margin: 0;
      position: absolute;
      height: 100%;
      width:100%;
      
      -webkit-touch-callout: none;
		-webkit-user-select: none;
		-khtml-user-select: none;
		-moz-user-select: none;
		-ms-user-select: none;
		user-select: none;
    }
     #perspectiveView{
        position: absolute;
        width: 100%;
        height: 100%;
        left: 0;
        z-index:1;
      }
      </style>
  </head>
<body>
  <!--Experimental-->
  
  <polymer-element name="assembly-step">
    <template>
      <style>
        :host{
          display:block;
          position:absolute;
          right:10px;
          z-index:10;
        }
        header{
          font-weight:bold;
        }
      </style>
      <header>Step:{{number}} </header>
      <div>
        <b>Instructions:</b> {{text}}
      </div>
      <div>
        Parts:
        <ul>
          <template repeat="{{part,partIndex in bom}}">
            <li>
              {{partIndex}}: {{part.description}} : {{part.amount}}
            </li>
          </template>
        </ul>
        Tools:
        <ul>
          <template repeat="{{tool,toolIndex in tools}}">
            <li>
              {{toolIndex}}: {{tool.name}}
            </li>
          </template>
        </ul>
      </div>
      <footer>
        <core-icon-button icon="fa-vid:{{ {'play':!isPlaying, 'pause':isPlaying} | tokenList }}" 
          on-tap="{{toggleAnimation}}">
        </core-icon-button>
        <core-icon-button icon="fa-vid:{{ {'backward':!isForward, 'forward':isForward} | tokenList }}" 
          on-tap="{{toggleAnimationDir}}">
        </core-icon-button>
        <core-icon-button icon="fa-dirs:chevron-right" on-tap="{{reqNew}}"></core-icon-button>
        
      </footer>
    </template>
    <script>Polymer("assembly-step", {
      number:0,
      text:"do some stuff",
      bom:[
        {
           partNumber:"",
           description:"bla",
           url:"",
           mimetype:"",
           thumbnailUrl:"",
           amount:10
        },
        {
           partNumber:"",
           description:"foo",
           url:"",
           mimetype:"",
           thumbnailUrl:"",
           amount:3
        },
      ],
      tools:[
        {name:"screwdriver"},
        {name:"hammer"},
      ],
      isPlaying:false,
      isForward:true,
      toggleAnimation:function()
      {
        this.isPlaying =! this.isPlaying;
      },
      toggleAnimationDir:function()
      {
        this.isForward =! this.isForward;
      }
    });
    </script>
  
  </polymer-element>
  
  
  <polymer-element name="assembly-viewer">
    <template>
      <assembly-step></assembly-step>
      <three-js id="threeJs">
        <three-stats id="stats" show=false></three-stats>
        <tween-js> </tween-js>
        <three-js-webglRenderer id="webglRenderer"></three-js-webglRenderer>
        <!--<three-js-css3dRenderer id="css3dRenderer"></three-js-css3dRenderer>-->
        <three-js-combinedCamera id="cam1" pos="[100,50,200]" orientation="diagonal" up=[0,0,1]></three-js-combinedCamera>

        <three-js-scene name="main" active>
          <three-js-light pos="[50,30,200]"></three-js-light>
          <three-js-light kind="spot" pos=[150,350,90] shadow></three-js-light>
        </three-js-scene>
        
        <three-js-scene name="helpers" active>
          <three-axis-helper> </three-axis-helper>
        </three-js-scene>
      
        <three-js-viewport name="perspective" id="perspectiveView" cameraId="#cam1" left=0 bottom=0 width=0.5 height=1.0 postProcess>
          <three-js-orbitControls cameraUp=[0,0,1] autoRotateSpeed="10"> </three-js-orbitControls>
          <!--<three-effect-composer ignore=["helpers"]>
            <vignette-fx> </vignette-fx>
          </three-effect-composer>-->
        </three-js-viewport>
      </three-js>
    </template>
    <script>Polymer("assembly-viewer", {
      addToScene:function(object,sceneName)
      {
        this.threeJs = this.$.threeJs;
        this.threeJs.addToScene(object,sceneName);
      }
    });
    </script>
  </polymer-element>
  
  <assembly-viewer></assembly-viewer>

  <script>
      window.addEventListener('polymer-ready', function() {
        console.log("web components ready");

	    var threeViewer = document.querySelector('assembly-viewer');
      console.log("threeViewer",threeViewer)
      //example : adding 3D shapes to viewer''
      var geometry = new THREE.BoxGeometry( 20, 20, 20 ); 
    	geometry.computeBoundingSphere();
      geometry.computeBoundingBox();
	    var material = new THREE.MeshLambertMaterial( {opacity:1,transparent:true,color: 0x0088ff} ); 
	    var cube = new THREE.Mesh(geometry, material);
      cube.name = "TargetCube";
      threeViewer.addToScene( cube );
      //add to scene
      /*var geometry = new THREE.SphereGeometry(12, 20,20);
    	geometry.computeBoundingSphere();
      geometry.computeBoundingBox();
      var material = new THREE.MeshLambertMaterial( {opacity:1,transparent:true,color: 0xff8800} );
      var sphere = new THREE.Mesh(geometry, material);
      sphere.name = "testSphere";
      sphere.position.set(50,0,30);
      cube.add(sphere);*/
      
      var boltHeight = 30;
      var geometry = new THREE.CylinderGeometry(9,12, boltHeight,6);
      geometry.applyMatrix(new THREE.Matrix4().makeRotationX( Math.PI / 2 ));
    	geometry.computeBoundingSphere();
      geometry.computeBoundingBox();
      var material = new THREE.MeshLambertMaterial( {opacity:1,transparent:true,color: 0xff8800} );
      var bolt = new THREE.Mesh(geometry, material);
      
      var target = bolt;
      threeViewer.addToScene( target );
      
      //connectors etc  
      //TODO: this is both a visual and a logic connector, should be seperate  
      var geometry = new THREE.BoxGeometry( 5, 5, 5 ); 
    	geometry.computeBoundingSphere();
      geometry.computeBoundingBox();
	    var material = new THREE.MeshLambertMaterial( {opacity:1,transparent:true,color: 0xff0000,wireframe:true} ); 
	    var tipConnector = new THREE.Mesh(geometry, material);
	    
	    target.add( tipConnector );
	    tipConnector.position.z = boltHeight/2;
	    
	    tipConnector.material.depthTest=false;
      tipConnector.material.depthWrite=false;
      tipConnector.renderDepth = 1e-20;
         
      
      //build instruction anims tests
      var playAnims = true;
      
      var startAnchor = new THREE.Vector3(-100,30,30);
      var endAnchor   = new THREE.Vector3(0,0,0);
      
      
      //for now use up vector as reference
      target.up = new THREE.Vector3(0,0,1);
      target.position.copy( startAnchor );
      
      var dirVect = endAnchor.clone().sub( startAnchor );
      var dirVectNorm = dirVect.clone().normalize();
      
      var angle = startAnchor.angleTo(endAnchor); //new THREE.Vector3(1,0,0).cross( direction );
      console.log("dirVect", dirVect, dirVectNorm, angle);
      
      if(playAnims) target.lookAt( endAnchor ) ;
      
      
      //visual indications
      var arrow = new DistanceHelper({start: startAnchor, end:endAnchor});
      threeViewer.addToScene( arrow );
      //var startToEndHelper = new SizeHelper({start: startAnchor, end:endAnchor,leftArrow:true,rightArrow:false,lineWidth:3, color:0xff0000});
      /*var startToEndHelper = new SizeHelper({length:dirVect.length(),position:startAnchor,leftArrow:true,rightArrow:true,lineWidth:3, color:0xff0000});
      threeViewer.addToScene( startToEndHelper );*/
      
      var duration =Â 10000;
      var turns = 6;
      var distance = 100;        
      var axis = new THREE.Vector3(1,0,0);

      var curPos = target.position;
      var curRot = target.rotation;
      
      var pos = endAnchor.clone();//new THREE.Vector3(100,20,0);
      var offs = 100;
      
      var curRot = new THREE.Euler();
      var targetRot = target.rotation.clone();
        
      var translation = new TWEEN.Tween( target.position )
        .to( { x: pos.x, y: pos.y, z:pos.z }, duration )
        .yoyo(true)
        .easing( TWEEN.Easing.Exponential.Out)
        .repeat(Infinity);

        var r = turns * Math.PI//*2 ;// + curRot.rotation.z;
        var rotation = new TWEEN.Tween( target.rotation )
          .to( { z:r}, duration )
          .yoyo(true)
          .easing( TWEEN.Easing.Exponential.Out)
          .repeat(Infinity);
        
        this._animations = [];
        this._animations.push( rotation );
        this._animations.push( translation );
      
        if(playAnims)
        {
          for(var i=0;i<this._animations.length;i++)
          {
            var anim = this._animations[i];
            anim.start();
          }
        }
        
        //TODO: branching and conditionals
        
        //steps:
        //stop animations
        //load animation data
        //load models
        
        //Exploring data structures for build instructions
        //based on tracker.json datastructure from TTN ?
        instructions = {"instructions":[
            {
               "step":1,
               "text":"do some stuff",
               "parts": [
               
               ],
               "logic":"screw #0001 into #0004 at [0,2,3]",
               "images":[
                  "thumbnails/..."
               ]
            },
            {
               "step":2,
               "text":"",
               "images":[
                  "thumbnails/..."
               ]
            }
         ]};
    });
  </script>  
</body>
</html>
